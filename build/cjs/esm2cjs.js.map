{
  "version": 3,
  "sources": ["../../src/esm/esm2cjs.ts", "../../shims/import.meta.url/shim.js"],
  "sourcesContent": ["import path from \"node:path\";\nimport { BuildOptions, build } from \"esbuild\";\nimport fs from \"node:fs/promises\";\nimport glob from \"tiny-glob\";\nimport { fileURLToPath } from \"node:url\";\n\nconst _dirname = path.dirname(fileURLToPath(import.meta.url));\nexport const shimsDir = path.join(_dirname, \"../../shims\");\n\nexport interface ESM2CJSOptions {\n\tinDir: string;\n\toutDir: string;\n\tcleanOutDir?: boolean;\n\tglobs?: string | string[];\n\tsourcemap?: boolean;\n\tlogLevel?: BuildOptions[\"logLevel\"];\n\tplatform?: BuildOptions[\"platform\"];\n\ttarget?: BuildOptions[\"target\"];\n\twritePackageJson?: boolean;\n\tpackageJsonSideEffects?: boolean | \"inherit\" | string[];\n\tpackageJsonImports?: \"inherit\" | Record<string, Record<string, string>>;\n\tkeepNames?: boolean;\n}\n\nexport async function esm2cjs({\n\tinDir,\n\toutDir,\n\tglobs = [\"**/*.js\"],\n\tsourcemap = true,\n\tlogLevel = \"warning\",\n\tplatform = \"node\",\n\ttarget = \"node18\",\n\tcleanOutDir = false,\n\twritePackageJson = true,\n\tpackageJsonSideEffects = \"inherit\",\n\tpackageJsonImports = \"inherit\",\n\tkeepNames = true,\n}: ESM2CJSOptions) {\n\t// Clean the output dir if necessary\n\tif (cleanOutDir) {\n\t\tawait fs.rm(outDir, { recursive: true, force: true });\n\t\tawait fs.mkdir(outDir, { recursive: true });\n\t}\n\n\t// Figure out what to compile\n\tif (typeof globs === \"string\") globs = [globs];\n\tconst entryPoints = (\n\t\tawait Promise.all(globs.map((g) => glob(g, { cwd: inDir })))\n\t).reduce((prev, cur) => [...prev, ...cur], []);\n\n\t// Compile ESM to CJS using esbuild\n\tconst buildResult = await build({\n\t\tabsWorkingDir: inDir,\n\t\tentryPoints,\n\t\toutdir: outDir,\n\t\tbundle: false,\n\t\tminify: false,\n\t\tmetafile: true,\n\t\tkeepNames,\n\t\tsourcemap,\n\t\tlogLevel,\n\t\tplatform,\n\t\tformat: \"cjs\",\n\t\ttarget,\n\t\tdefine: {\n\t\t\t\"import.meta.url\": \"__import_meta_url\",\n\t\t},\n\t\tinject: [path.join(shimsDir, \"import.meta.url/shim.js\")],\n\t});\n\n\t// Copy .d.ts files\n\tif (buildResult.metafile) {\n\t\tfor (const inputFile of Object.keys(buildResult.metafile.inputs)) {\n\t\t\tif (inputFile.startsWith(\".\")) {\n\t\t\t\t// File outside of the build directory, skip\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tconst declarationFileName = inputFile.replace(\n\t\t\t\t/\\.([cm]?)js$/,\n\t\t\t\t\".d.$1ts\",\n\t\t\t);\n\t\t\t// Try to copy the file, but don't fail if it doesn't exist\n\t\t\tawait fs\n\t\t\t\t.copyFile(\n\t\t\t\t\tpath.join(inDir, declarationFileName),\n\t\t\t\t\tpath.join(outDir, declarationFileName),\n\t\t\t\t)\n\t\t\t\t.catch(() => {});\n\t\t}\n\t}\n\n\t// If desired, define the module type of each build directory separately\n\tif (writePackageJson) {\n\t\t// Some properties must or should be inherited from the parent package.json\n\t\tconst parentPackageJson = await fs\n\t\t\t.readFile(path.join(process.cwd(), \"package.json\"), \"utf-8\")\n\t\t\t.then((data) => JSON.parse(data))\n\t\t\t.catch(() => undefined);\n\n\t\t// \"sideEffects\"\n\t\tlet inheritedSideEffects: Record<string, any> | undefined;\n\t\tif (\n\t\t\tpackageJsonSideEffects === \"inherit\" &&\n\t\t\tparentPackageJson?.sideEffects != undefined\n\t\t) {\n\t\t\tinheritedSideEffects = {\n\t\t\t\tsideEffects: parentPackageJson.sideEffects,\n\t\t\t};\n\t\t}\n\t\tconst normalizedSideEffects =\n\t\t\t// Assume the package has side effects, unless explicitly stated otherwise\n\t\t\tpackageJsonSideEffects === true ||\n\t\t\tpackageJsonSideEffects === undefined\n\t\t\t\t? {}\n\t\t\t\t: packageJsonSideEffects === \"inherit\"\n\t\t\t\t? inheritedSideEffects ?? {}\n\t\t\t\t: { sideEffects: packageJsonSideEffects };\n\n\t\t// \"imports\"\n\t\tlet esmImports: Record<string, Record<string, string>> | undefined;\n\t\tif (\n\t\t\tpackageJsonImports === \"inherit\" &&\n\t\t\tparentPackageJson?.imports != undefined\n\t\t) {\n\t\t\t// Inherited imports need to be rewritten to be relative to the input directory\n\t\t\tesmImports = rewriteImports(\n\t\t\t\tparentPackageJson.imports,\n\t\t\t\tprocess.cwd(),\n\t\t\t\tinDir,\n\t\t\t);\n\t\t} else if (typeof packageJsonImports === \"object\") {\n\t\t\tesmImports = packageJsonImports;\n\t\t}\n\t\tconst normalizedESMImports = esmImports ? { imports: esmImports } : {};\n\t\t// Rewrite paths that are relative to the input directory to be relative to the output directory\n\t\tconst cjsImports =\n\t\t\tesmImports && rewriteImports(esmImports, inDir, outDir);\n\t\tconst normalizedCJSImports = cjsImports ? { imports: cjsImports } : {};\n\n\t\tawait fs.writeFile(\n\t\t\tpath.join(inDir, \"package.json\"),\n\t\t\tJSON.stringify(\n\t\t\t\t{\n\t\t\t\t\ttype: \"module\",\n\t\t\t\t\t...normalizedSideEffects,\n\t\t\t\t\t...normalizedESMImports,\n\t\t\t\t},\n\t\t\t\tnull,\n\t\t\t\t4,\n\t\t\t) + \"\\n\",\n\t\t);\n\t\tawait fs.writeFile(\n\t\t\tpath.join(outDir, \"package.json\"),\n\t\t\tJSON.stringify(\n\t\t\t\t{\n\t\t\t\t\ttype: \"commonjs\",\n\t\t\t\t\t...normalizedSideEffects,\n\t\t\t\t\t...normalizedCJSImports,\n\t\t\t\t},\n\t\t\t\tnull,\n\t\t\t\t4,\n\t\t\t) + \"\\n\",\n\t\t);\n\t}\n}\n\nfunction rewriteImports(\n\timports: Record<string, Record<string, string>>,\n\tsourceDir: string,\n\ttargetDir: string,\n): Record<string, Record<string, string>> {\n\tconst ret: Record<string, Record<string, string>> = {};\n\tfor (const [importName, specs] of Object.entries(imports)) {\n\t\tconst newSpecs: Record<string, string> = {};\n\t\tfor (const [specifier, importPath] of Object.entries(specs)) {\n\t\t\tif (!importPath.startsWith(\".\")) {\n\t\t\t\t// Absolute path, no need to rewrite\n\t\t\t\tnewSpecs[specifier] = importPath;\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst absolute = path.resolve(sourceDir, importPath);\n\t\t\tlet relativeToTarget = path.relative(targetDir, absolute);\n\t\t\tif (!relativeToTarget.startsWith(\".\")) {\n\t\t\t\trelativeToTarget = \"./\" + relativeToTarget;\n\t\t\t}\n\n\t\t\tnewSpecs[specifier] = relativeToTarget;\n\t\t}\n\t\tret[importName] = newSpecs;\n\t}\n\treturn ret;\n}\n", "export const __import_meta_url =\n  typeof document === 'undefined' ? new (require('url'.replace('', '')).URL)('file:' + __filename).href :\n    (document.currentScript && document.currentScript.src || new URL('main.js', document.baseURI).href)\n"],
  "mappings": "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",
  "names": ["path", "fs", "glob"]
}
